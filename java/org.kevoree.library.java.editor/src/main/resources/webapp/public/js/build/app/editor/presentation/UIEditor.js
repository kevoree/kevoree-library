define(["util/ModelHelper","util/AlertPopupHelper","util/Config","templates/lib-tree","bootstrap/modal","jquery","jqueryui/droppable","jqueryui/draggable","jqueryui/effect-highlight","tinysort","touchpunch","hammer"],function(e,t,n,r,i,s){function l(e,t){this._ctrl=e,this._id=t,this._currentWire=null,this._modelLayer=new Kinetic.Layer,this._wireLayer=new Kinetic.Layer,this._scale=1}function c(e,t){e.siblings().each(function(){a[s(this).attr("data-entity")]==1&&f[e.text()]==1&&s(this).show("fast")}),t.addClass("icon-arrow-right"),t.removeClass("icon-arrow-down")}var o=".uieditor",u=!1,a=[],f=[];return l.prototype.create=function(e,t){this._stage=new Kinetic.Stage({container:this._id,width:e,height:t});var r=new Kinetic.Layer,i=new Image;i.onload=function(){var e=new Kinetic.Image({image:i,width:i.width,height:i.height});r.add(e),r.setZIndex(0),r.draw()},i.src=n.BACKGROUND_IMG,this._stage.add(r),this._stage.add(this._modelLayer),this._stage.add(this._wireLayer);var s=this;this._stage.on("mousemove touchmove",function(){s._ctrl.p2cMouseMove(this.getTouchPosition()||this.getPointerPosition())}),this._stage.on("dbltap",function(){s._ctrl.p2cDblTap()}),this._stage.on("mouseup touchend",function(){s._ctrl.p2cMouseUp(this.getTouchPosition()||this.getPointerPosition()),s._scale>1?s._stage.setDraggable(!0):s._stage.setDraggable(!1),s._wireLayer.draw()}),this._registerCallbacks()},l.prototype._registerCallbacks=function(){var e=this;s(window).off(o),s(window).on("smartresize"+o,function(){e._stage.setSize(s("#"+e._id).width(),s("#"+e._id).height()),e._wireLayer.draw()}),s("#toggle-lib-tree").off(o),s("#toggle-lib-tree").on("click"+o,function(){e._ctrl.p2cToggleLibTree()}),s("#editor").off(o),s("#editor").on("dblclick"+o,function(){e._ctrl.p2cDblTap()}),s("#lib-tree-content .nav-header").off(o),s("#lib-tree-content .nav-header").on("click"+o,function(){var e=s(this),t=e.find(".lib-subtree-icon");t.hasClass("icon-arrow-right")?(f[e.text()]=!1,e.siblings().hide("fast"),t.removeClass("icon-arrow-right"),t.addClass("icon-arrow-down")):(f[e.text()]=!0,c(e,t))}),s("#lib-tree-search").off(o),s("#lib-tree-search").on("keyup"+o,function(){s(".lib-item").filter(function(){var e=s(this),t=e.text().toLowerCase(),n=s("#lib-tree-search").val().toLowerCase();t.search(n)==-1?e.hide():a[e.attr("data-entity")]&&f[e.siblings(".lib-tree-library").text()]&&e.show()})}),s("[id^=lib-tree-settings-filter-]").off(o),s("[id^=lib-tree-settings-filter-]").on("click"+o,function(){var e=s(this).children(".checkbox").first();return e.prop("checked",!e.prop("checked")),e.trigger("click"),!1}),s("[id^=lib-tree-settings-filter-] .checkbox").off(o),s("[id^=lib-tree-settings-filter-] .checkbox").on("click"+o,function(){var e=!s(this).prop("checked"),t=s(this).val();e?(a[t]=!0,s(".lib-tree-library").each(function(){var e=s(this);e.siblings(".lib-item[data-entity="+t+"]").each(function(){f[e.text()]&&s(this).show("fast")})})):(a[t]=!1,s(".lib-item[data-entity="+t+"]").each(function(){s(this).hide("fast")}))}),s(".lib-item").off(o),s(".lib-item").on("mouseenter"+o,function(){s(this).find(".lib-item-count").stop(!0,!0).delay(600).fadeOut(),s(this).find(".lib-item-name").css("overflow","visible")}),s(".lib-item").on("mouseleave"+o,function(){s(this).find(".lib-item-count").stop(!0,!0).delay(600).fadeIn(),s(this).find(".lib-item-name").css("overflow","hidden")}),s("#lib-tree-settings-toggle-fold").off(o),s("#lib-tree-settings-toggle-fold").on("click"+o,function(){e._ctrl.p2cFoldAllLibTree()}),s(".lib-item").hammer().off("tap"),s(".lib-item").hammer().on("tap",function(){s(".lib-item").removeClass("selected"),s(this).addClass("selected")}),s(".lib-item").hammer().off("doubletap"),s(".lib-item").hammer().on("doubletap",function(){e._addEntity(s(this))}),s(".lib-item").draggable({revert:"invalid",helper:function(){var e=s(this).clone();return e.children(".lib-item-count").remove(),e.addClass("dragged"),e},cursor:"move",cursorAt:{top:-5,right:-5}}),s("#editor").droppable({drop:function(t,n){var r=s("#editor").offset(),i=e._stage.getScale(),o={x:(t.pageX-r.left)/i.x,y:(t.pageY-r.top)/i.y};e._ctrl.p2cEntityDropped(o)},over:function(t,n){var r=n.draggable.attr("data-entity"),i=n.draggable.find(".lib-item-name").text();e._ctrl.p2cEntityDraggedOver(r,i)},out:function(){e._ctrl.p2cEntityDraggedOut()}});var t=s("#component-tooltip").prop("checked");this.enableTooltips(t)},l.prototype.enableTooltips=function(e){e?s(".lib-item[data-entity='ComponentType']").tooltip({selector:s(this),placement:"bottom",title:"You have to drop this element in a Node",trigger:"hover",delay:{show:500,hide:0}}):s(".lib-item[data-entity='ComponentType']").tooltip("destroy")},l.prototype.enableAlertPopups=function(e){t.setEnabled(e)},l.prototype.c2pEntityAdded=function(e){this.addShape(e.getShape()),e.ready();var t=this._ctrl.getEntityCount(e.getCtrl().getType());s(".lib-item-name").each(function(){s(this).text()==e.getCtrl().getType()&&(s(this).siblings(".lib-item-count").size()>0?s(this).siblings(".lib-item-count").children(".badge").text(t):t!=0&&s(this).parent().append("<div class='lib-item-count'><span class='badge'>"+t+"</span>"+"</div>"))})},l.prototype.c2pDropImpossible=function(e){s(".lib-item-name").each(function(){s(this).text()==e.getCtrl().getType()&&(s(this).effect("highlight",{color:"#f00"},500),s(this).parent().tooltip("show"))})},l.prototype.c2pZoomIn=function(){this._scale=this._scale+.1,this._scale>1&&this._stage.setDraggable(!0),this._stage.setScale(this._scale),this._stage.draw()},l.prototype.c2pZoomTo=function(e){this._scale=e,this._stage.setScale(this._scale),this._scale>1?this._stage.setDraggable(!0):(this._stage.setDraggable(!1),this._stage.setPosition(0,0)),this._stage.draw()},l.prototype.c2pZoomDefault=function(){this._scale=1,this._stage.setScale(this._scale),this._stage.setDraggable(!1),this._stage.setPosition(0,0),this._stage.draw()},l.prototype.c2pZoomOut=function(){this._scale=this._scale-.1,this._scale<1&&(this._stage.setPosition(0,0),this._stage.setDraggable(!1)),this._stage.setScale(this._scale),this._stage.draw()},l.prototype.c2pHideLibTree=function(){s("#lib-tree").hide(),s("#editor-panel").removeClass("span9"),this._stage.setSize(s("#"+this._id).width(),s("#"+this._id).height())},l.prototype.c2pFoldAllLibTree=function(){s("#lib-tree-settings-toggle-fold").text("Unfold all"),s("#lib-tree-content .nav-header").each(function(){var e=s(this).children().first();e.hasClass("icon-arrow-right")&&(f[s(this).text()]=!1,s(this).siblings().hide("fast"),e.removeClass("icon-arrow-right"),e.addClass("icon-arrow-down"))}),u=!0},l.prototype.c2pUnfoldAllLibTree=function(){s("#lib-tree-settings-toggle-fold").text("Fold all"),s("#lib-tree-content .nav-header").each(function(){var e=s(this).children().first();e.hasClass("icon-arrow-down")&&(f[s(this).text()]=!0,c(s(this),e))}),u=!1},l.prototype.c2pShowLibTree=function(){s("#lib-tree").show(),s("#editor-panel").addClass("span9"),this._stage.setSize(s("#"+this._id).width(),s("#"+this._id).height()),this._wireLayer.draw()},l.prototype.c2pEntityRemoved=function(e){var t=this._ctrl.getEntityCount(e.getCtrl().getType());s(".lib-item-name").each(function(){s(this).text()==e.getCtrl().getType()&&(t==0?s(this).siblings(".lib-item-count").remove():s(this).siblings(".lib-item-count").children(".badge").text(t))})},l.prototype.c2pUpdateWire=function(e,t){var n=this._stage.getScale();t={x:t.x/n.x,y:t.y/n.y},e.setTargetPoint(t),this._wireLayer.draw()},l.prototype.getWiresLayer=function(){return this._wireLayer},l.prototype.c2pEntityUpdated=function(e){this._stage.draw(),this._wireLayer.draw()},l.prototype.c2pWireAdded=function(e){this._scale>1&&this._stage.setDraggable(!1)},l.prototype.c2pModelUpdated=function(){s(".lib-tree-info").hide(),f=[],s("#lib-tree-settings-toggle-fold").text("Fold all"),u=!1,s("#lib-tree-content li, #lib-tree-content ul").remove();var t=e.getLibraries(this._ctrl.getModel());for(var n in t){f[t[n].name]=!0;for(var i in t[n].components){var o=t[n].components[i];a[o.type]==undefined&&(a[o.type]=!0)}}s("#lib-tree-content").html(r({libz:t})),s(".nav-list, .lib-item").tsort(),this._registerCallbacks(),s(".lib-item").each(function(){a[s(this).attr("data-entity")]||s(this).hide()}),this._stage.draw()},l.prototype.c2pClear=function(){s("#lib-tree-content li, #lib-tree-content ul").remove(),s(".lib-tree-info").show()},l.prototype.addShape=function(e){this._modelLayer.add(e),this._modelLayer.draw()},l.prototype.getStage=function(){return this._stage},l.prototype.draw=function(){this._stage.draw(),this._wireLayer.draw()},l.prototype._addEntity=function(e){var t=e.attr("data-entity"),n=e.find(".lib-item-name").text();this._ctrl.p2cEntityDraggedOver(t,n),this._ctrl.p2cEntityDropped({x:100,y:100})},l});