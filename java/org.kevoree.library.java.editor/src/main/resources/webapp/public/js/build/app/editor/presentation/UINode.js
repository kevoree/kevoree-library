define(["presentation/UINestableEntity","util/Pooffs"],function(e,t){function s(t){e.prototype.constructor.call(this,t),this._rect.setName(s.SHAPE_NAME),this._shape.setOffset(this._rect.getWidth()/2,this._rect.getHeight()/2);var n=this;this._shape.on("mouseover touchmove",function(e){n._ctrl.p2cMouseOver(),e.cancelBubble=!0});var r=t.getNodeProperties().getUI();this._shape.on("dblclick dbltap",function(e){e.cancelBubble=!0,r.show()}),this._shape.on("dragend",function(){n._ctrl.p2cDragEnd()})}var n="#FFF",r="#F00",i="#0F0";return s.SHAPE_NAME="kev_node",t.extends(s,e),s.prototype.c2pAddChild=function(e){e.getShape().setPosition(0,0),e.getShape().setOffset(0,0),e.getShape().remove(),this._shape.add(e.getShape()),e.ready();var t=this._ctrl.getParent();t&&t.getUI().redrawParent(),this._shape.draw(),this._shape.getLayer().draw()},s.prototype.c2pMouseOut=function(){document.body.style.cursor="default",this._border.setAttrs({stroke:n}),this._shape.getLayer().draw()},s.prototype.c2pDropPossible=function(e){document.body.style.cursor="pointer",this._border.setAttrs({stroke:i}),e&&this._shape.getLayer().draw()},s.prototype.c2pDropImpossible=function(e){document.body.style.cursor="pointer",this._border.setAttrs({stroke:r}),e&&this._shape.getLayer().draw()},s.prototype.c2pChildRemoved=function(e){this._ctrl.getParent()&&this._ctrl.getParent().getUI().redrawParent()},s.prototype.c2pChildDragStarted=function(e){var t=e.getShape(),n=t.getAbsolutePosition();t.remove(),this._shape.getLayer().add(t),t.setPosition(n),t.setZIndex(0),t.fire("dragstart.fake"),this._shape.getLayer().draw()},s.prototype.getPosition=function(e){var t=this._shape.getAbsolutePosition(),n=this._shape.getOffset(),r=this._rect.getWidth(),i=this._shape.getStage().getScale(),s=this._shape.getStage().getPosition(),t={x:(t.x-s.x)/i.x,y:(t.y-s.y)/i.y};return e&&e.x>t.x-n.x+r/2+10?{x:t.x-n.x+r-10,y:t.y-n.y+10}:{x:t.x-n.x+10,y:t.y-n.y+10}},s.prototype.c2pWireCreated=function(e){e.getCtrl().getOrigin().getUI().getShape().setDraggable(!0),this._mouseUpEvent&&(this._mouseUpEvent=null)},s.prototype._draw=function(){var t=this.getHeader().getWidth(),r=this.getHeader().getHeight(),i=this._shape.getStage().getPointerPosition()||this._shape.getStage().getMousePosition();if(this._ctrl.getParent()){var s=this._ctrl.getParent().getUI(),o=s.getChildOffset(this);this._shape.setOffset(-o.x,-o.y),t=s.getWidth()-e.CHILD_X_PADDING}if(this._ctrl.hasChildren()){var u=0,a=0,f=this._ctrl.getChildren();for(var l=0;l<f.length;l++){var c=f[l].getUI();c.getWidth()>u&&(u=c.getWidth()),a+=c.getHeight()+e.CHILD_Y_PADDING}for(var l=0;l<f.length;l++){var c=f[l].getUI();u<t-e.CHILD_X_PADDING?c.setWidth(this.getWidth()-e.CHILD_X_PADDING):(t=u+e.CHILD_X_PADDING,c.setWidth(u))}r=a+this.getHeader().getHeight()}this._rect.setWidth(t),this._rect.setHeight(r),this.getHeader().setOffset(-(t/2-this.getHeader().getWidth()/2),0),this.containsPoint(i)&&this._noChildrenContainsPoint(i)?this._ctrl.p2cBeforeDraw():this._border.setAttrs({stroke:n})},s});