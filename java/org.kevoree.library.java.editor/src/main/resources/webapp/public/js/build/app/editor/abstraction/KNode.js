define(["abstraction/KEntity","abstraction/KComponent","abstraction/property/KNodeProperties","util/Pooffs"],function(e,t,n,r){function s(t,n){e.prototype.constructor.call(this,t,n),this._parent=null,this._children=new Array,this._name="node"+i++,this._props=require("factory/CFactory").getInstance().newNodeProperties(this)}var i=0;return s.ENTITY_TYPE="NodeType",r.extends(s,e),s.prototype.getEntityType=function(){return s.ENTITY_TYPE},s.prototype.addChild=function(e){if(this.isValidChildEntity(e)){var t=this._children.indexOf(e);return t==-1&&(this._children.push(e),e.setParent(this),this.getEditor().addNestableEntity(e)),!0}return!1},s.prototype.getChildren=function(){return this._children},s.prototype.getEntity=function(e){for(var t=0;t<this._children.length;t++){if(this._children[t].getName()==e)return this._children[t];if(this._children[t].getEntity&&typeof this._children[t].getEntity=="function"){var n=this._children[t].getEntity(e);if(n!=null)return n}}return null},s.prototype.hasChild=function(e){for(var t=0;t<this._children.length;t++)if(this._children[t].getName()==e.getName())return!0;return!1},s.prototype.removeChild=function(e){var t=this._children.indexOf(e);t!=-1&&(this._children.splice(t,1),this.getEditor().removeNestableEntity(e),e.setParent(null))},s.prototype.isValidChildEntity=function(e){return(e.getEntityType()==s.ENTITY_TYPE||e.getEntityType()==t.ENTITY_TYPE)&&this!==e},s.prototype.setParent=function(e){this._parent=e},s.prototype.getParent=function(){return this._parent},s.prototype.addWire=function(e){if(this._wires.indexOf(e)==-1){this._wires.push(e),this.getEditor().addWire(e);var t=e.getOrigin().getDictionaryAttributes(),n=require("factory/CFactory").getInstance();for(var r=0;r<t.length;r++)if(t[r].getFragmentDependant()){var i=n.newValue();i.setName(t[r].getName()),i.setValue(t[r].getDefaultValue());var s=e.getOrigin().getFragmentDictionary(this._name);s==null&&(s=n.newDictionary(this,!0),e.getOrigin().addFragmentDictionary(s)),console.log("addWire",s,i),s.addValue(i)}}},s.prototype.disconnect=function(t){e.prototype.disconnect.call(this,t);var n=t.getOrigin()._dictionary,r=n.getValues().slice(0);for(var i=0;i<r.length;i++)r[i].getAttribute().getFragmentDependant()&&r[i].getTargetNode().getName()==this.getName()&&n.removeValue(r[i])},s.prototype.hasChildren=function(){return this._children.length>0},s.prototype.remove=function(){var t=this._children.slice(0);for(var n=0;n<t.length;n++)t[n].remove();this._children=[],this._parent&&this._parent.removeChild(this),this._props.remove(),e.prototype.remove.call(this)},s.prototype.getMaxChildTreeDepth=function(){var e=0;for(var t=0;t<this._children.length;t++){var n;this._children[t].hasChildren()?n=this._children[t].getMaxChildTreeDepth()+1:n=1,n>e&&(e=n)}return e},s.prototype.getNodeProperties=function(){return this._props},s.prototype.accept=function(e){e.visitNode(this)},s.prototype.getNodeProperties=function(){return this._props},s});