define(["kevoree","abstraction/KGroup","abstraction/KInputPort","abstraction/KOutputPort","util/Util"],function(e,t,n,r,i){function s(){this._factory=new e.org.kevoree.impl.DefaultKevoreeFactory,this._listener=function(){}}function o(e){if(typeof e.getUI=="function"&&e.getUI()&&e.getUI().getShape()){var t=e.getUI().getShape().getAbsolutePosition();e._instance.setMetaData("x="+parseInt(t.x)+",y="+parseInt(t.y))}}return s.prototype.setModel=function(e){this._model=e},s.prototype.setListener=function(e){if(!e||typeof e!="function")throw"UpdateModelVisitor setListener's callback is not a function.";this._listener=e},s.prototype.visitChannel=function(e){e._instance=e._instance||this._factory.createChannel(),e._instance.setName(e._name),e._instance.setTypeDefinition(this._model.findTypeDefinitionsByID(e._type+"/")),o(e),e.getDictionary().accept(this),this._model.addHubs(e._instance),this._listener.call(this)},s.prototype.visitNode=function(e){e._instance=e._instance||this._factory.createContainerNode(),e._props._instance=e._instance,e._instance.setName(e._name),e._instance.setTypeDefinition(this._model.findTypeDefinitionsByID(e._type+"/")),o(e),e.getDictionary().accept(this),this._model.addNodes(e._instance);if(e._parent){var t=this._model.findNodesByID(e._parent.getName());t.addHosts(e._instance)}if(e._children.length>0)for(var n=0;n<e._children.length;n++)e._children[n].accept(this);if(e._wires.length>0)for(var n=0;n<e._wires.length;n++)e._wires[n].getOrigin().accept(this);this._listener.call(this)},s.prototype.visitComponent=function(e){e._instance=e._instance||this._factory.createComponentInstance(),e._instance.setName(e._name),e._instance.setTypeDefinition(this._model.findTypeDefinitionsByID(e._type+"/")),o(e),e.getDictionary().accept(this);var t=this._model.findNodesByID(e._parent.getName());t.addComponents(e._instance);for(var n=0;n<e._inputs.length;n++)e._inputs[n].accept(this);for(var n=0;n<e._outputs.length;n++)e._outputs[n].accept(this);for(var n=0;n<e._wires.length;n++)e._wires[n].accept(this);this._listener.call(this)},s.prototype.visitGroup=function(e){e._instance=e._instance||this._factory.createGroup(),e._instance.setName(e._name),e._instance.setTypeDefinition(this._model.findTypeDefinitionsByID(e._type+"/")),o(e);var t=e._instance.getTypeDefinition().getDictionaryType(),n=t.getAttributes()?t.getAttributes().iterator():null;if(n)while(n.hasNext()){var r=n.next(),s=require("factory/CFactory").getInstance().newAttribute();s.setName(r.getName()),s.setOptional(i.parseBoolean(r.getOptional())),s.setFragmentDependant(i.parseBoolean(r.getFragmentDependant())),s.setDefaultValue(r.getDefaultValue()),e.addDictionaryAttribute(s)}e.getDictionary().accept(this);for(var u=0;u<e.getFragmentDictionaries().length;u++)e.getFragmentDictionaries()[u].accept(this);if(e._wires.length>0)for(var u=0;u<e._wires.length;u++)e._wires[u].accept(this);this._model.addGroups(e._instance),this._listener.call(this)},s.prototype.visitWire=function(e){switch(e.getOrigin().getEntityType()){case t.ENTITY_TYPE:var i=this._model.findNodesByID(e.getTarget().getName()),s=this._model.findGroupsByID(e.getOrigin().getName());i&&s&&s.addSubNodes(i);break;case n.ENTITY_TYPE:case r.ENTITY_TYPE:var o=this._model.findHubsByID(e.getTarget().getName()),u=e._instance?!0:!1;e._instance=e._instance||this._factory.createMBinding(),e.getOrigin()._instance||e.getOrigin().accept(this),e._instance.setPort(e.getOrigin()._instance),e._instance.setHub(o),u||this._model.addMBindings(e._instance)}this._listener.call(this)},s.prototype.visitOutputPort=function(e){var t=this._model.findNodesByID(e._component.getParent().getName()),n=t.findComponentsByID(e._component.getName()),r=n.getTypeDefinition().findRequiredByID(e.getName()),i=e._instance?!0:!1;e._instance=e._instance||this._factory.createPort(),i||n.addRequired(e._instance),e._instance.setPortTypeRef(r),this._listener.call(this)},s.prototype.visitInputPort=function(e){var t=this._model.findNodesByID(e._component.getParent().getName()),n=t.findComponentsByID(e._component.getName()),r=n.getTypeDefinition().findProvidedByID(e.getName()),i=e._instance?!0:!1;e._instance=e._instance||this._factory.createPort(),i||n.addProvided(e._instance),e._instance.setPortTypeRef(r),this._listener.call(this)},s.prototype.visitNodeProperties=function(e){var t=e.getNodeNetworks();for(var n=0;n<t.length;n++)t[n].accept(this)},s.prototype.visitNodeNetwork=function(e){var t=this._model.findNodesByID(e._target.getName()),n=this._model.findNodesByID(e._initBy.getName());e._instance&&this._model.removeNodeNetworks(e._instance),e._instance=this._factory.createNodeNetwork(),e._instance.setTarget(t),e._instance.setInitBy(n);var r=e.getTarget().getNodeProperties().getLinks();for(var i in r){var s=this._factory.createNodeLink();s.setNetworkType(r[i].getNetworkType()),s.setEstimatedRate(r[i].getEstimatedRate());var o=r[i].getNetworkProperties();for(var u in o)if(o[u].getKey()!=null&&o[u].getValue()!=null){var a=this._factory.createNetworkProperty();a.setName(o[u].getKey()),a.setValue(o[u].getValue()),s.addNetworkProperties(a)}e._instance.addLink(s)}this._model.addNodeNetworks(e._instance),this._listener.call(this)},s.prototype.visitNodeLink=function(e){e.getNodeProperties().accept(this)},s.prototype.visitNetworkProperty=function(e){e.getLink().getNodeProperties().accept(this)},s.prototype.visitDictionary=function(e){e.isFragment()?e._instance=e._instance||this._factory.createFragmentDictionary():e._instance=e._instance||this._factory.createDictionary(),e._instance.removeAllValues();for(var t=0;t<e.getValues().length;t++)e.getValues()[t].accept(this);e.isFragment()?e.getEntity()._instance.addFragmentDictionary(e._instance):e.getEntity()._instance.setDictionary(e._instance),this._listener.call(this)},s.prototype.visitValue=function(e){e._instance=e._instance||this._factory.createDictionaryValue(),e._instance.setName(e.getName()),e._instance.setValue(e.getValue()),this._listener.call(this)},s});