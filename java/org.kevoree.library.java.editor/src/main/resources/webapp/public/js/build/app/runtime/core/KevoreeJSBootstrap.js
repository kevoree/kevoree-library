define(["kevoree","util/Logger"],function(e,t){function n(){this._started=!1,this._factory=new e.org.kevoree.impl.DefaultKevoreeFactory}function r(e,n,r,i,s){var o=e.findNodesByID(r);if(o==null){var u=e.findTypeDefinitionsByID(n);if(u!=null){t.warn("Init default node instance for name "+r);var a=s.createContainerNode();a.setName(r),a.setTypeDefinition(u),e.addNodes(a);var f=e.findTypeDefinitionsByID(i);if(f!=null){var l=s.createGroup();return l.setTypeDefinition(f),l.setName("sync"),l.addSubNodes(a),e.addGroups(l),!0}t.err("Default group type not found in model for typeDef "+i)}else t.err('Default node type not found in model for typeDef "'+n+'"')}else t.debug('Model already initialized with a node instance using "'+r+'"');return!1}return n.prototype.start=function(n,i,s,o){function a(){if(o&&typeof o=="function"){o.call(undefined,u._started);return}}var u=this;this._started&&a();var f=new WebSocket("ws://"+s);f.onerror=function(){a()},f.onclose=function(e){var n="";switch(e.code){case 1e3:n="WebSocket to "+f.url+" closed.",console.log(n),t.log(n);break;default:n="WebSocket to "+f.url+" closed. Reason code "+e.code+' (<a href="https://developer.mozilla.org/en-US/docs/XPCOM_Interface_Reference/nsIWebSocketChannel#Status_codes" target="_blank">codes</a>)',console.warn(n),t.warn(n)}},f.onmessage=function(s){try{var o=new e.org.kevoree.loader.JSONModelLoader,l=s.data,c=o.loadModelFromString(l);if(c&&c.size()>0){var h=c.get(0);u._started=r(h,"WebNode",n,i,u._factory)}else t.warn("Unable to read message received from server.")}catch(p){throw t.err(p.message),p}finally{a(),f.close()}},f.onopen=function(){t.log("Connection to "+f.url+" succeed. Retrieving model..."),f.send("2")}},n.prototype.stop=function(){if(!this._started)return;this._started=!1},n});