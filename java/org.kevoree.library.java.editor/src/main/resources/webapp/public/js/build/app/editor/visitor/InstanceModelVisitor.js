define(["util/Util","abstraction/KComponent","abstraction/KNode"],function(e,t,n){function r(){this._factory=require("factory/CFactory").getInstance()}function i(e,t,n){for(var r=0;r<n.size();r++){var i=n.get(r),s=t.newNode(e,i.getTypeDefinition().getName());s._instance=i,s.getDictionary()._instance=i.getDictionary(),s.setName(i.getName());if(!e.hasEntity(s)){i.getHost()||(e.addEntity(s),c(s,i),h(s,i,t));if(i.getHost()){var o=e.getEntity(i.getHost().getName());o.addChild(s),h(s,i,t)}}}}function s(e,t,n){var r=null,i=null;for(var s=0;s<n.size();s++){i=n.get(s),r=t.newGroup(e,i.getTypeDefinition().getName()),r._instance=i,r.getDictionary()._instance=i.getDictionary();var o=i.getFragmentDictionary()?i.getFragmentDictionary().iterator():null;if(o)while(o.hasNext())var u=o.next();r.setName(i.getName()),e.addEntity(r),c(r,i),h(r,i,t)}}function o(e,t,n){var r=null,i=null;for(var s=0;s<n.size();s++){i=n.get(s);var o=e.getEntity(i.getName());if(o!=null){var u=i.getComponents();for(var a=0;a<u.size();a++){var f=u.get(a);r=t.newComponent(e,f.getTypeDefinition().getName()),r._instance=f,r.getDictionary()._instance=f.getDictionary(),r.setName(f.getName()),o.addChild(r),h(r,f,t)}}}}function u(e,t,n){var r=null,i=null;for(var s=0;s<n.size();s++)i=n.get(s),r=t.newChannel(e,i.getTypeDefinition().getName()),r._instance=i,r.getDictionary()._instance=i.getDictionary(),r.setName(i.getName()),e.addEntity(r),c(r,i),h(r,i,t)}function a(e,t,n){for(var r=0;r<n.size();r++){var i=n.get(r).getSubNodes();for(var s=0;s<i.$size;s++){var o=e.getEntity(n.get(r).getName()),u=e.getEntity(i.get(s).getName());if(o!=null&&u!=null){var a=t.newWire(o);a.setTarget(u),o.addWire(a),u.addWire(a)}}}}function f(e,t,n){for(var r=0;r<n.size();r++){var i=n.get(r).getPort(),s=n.get(r).getHub();if(i&&s){var o=e.getEntity(i.eContainer().getName()),u=e.getEntity(s.getName());if(o&&u){for(var a=0;a<i.eContainer().getProvided().size();a++){var f=i.eContainer().getProvided().get(a);if(i.getPortTypeRef()==f.getPortTypeRef()){var l=o.getPort(i.getPortTypeRef().getName());l!=null&&h(l,o,u)}}for(var a=0;a<i.eContainer().getRequired().size();a++){var c=i.eContainer().getRequired().get(a);if(i.getPortTypeRef()==c.getPortTypeRef()){var l=o.getPort(i.getPortTypeRef().getName());l!=null&&h(l,o,u)}}}function h(e,t,s){e.setComponent(t),e._instance=i;var o=e.createWire();o._instance=n.get(r),o.setTarget(s),s.addWire(o)}}}}function l(e,t,n){function p(e,t){var n=t.getNodeProperties().getNodeNetworks();for(var r in n)if(n[r].getInitBy().getName()==e.getName()&&n[r].getTarget().getName()==t.getName())return n[r];return null}for(var r=0;r<n.size();r++){var i=e.getEntity(n.get(r).getInitBy().getName()),s=e.getEntity(n.get(r).getTarget().getName());if(i&&s){var o=p(i,s);o||(o=t.newNodeNetwork(i,s),o._instance=n.get(r),s.getNodeProperties().addNodeNetwork(o));var u=n.get(r).getLink();u.size()>0&&s.getNodeProperties().removeAllLinks();for(var a=0;a<u.size();a++){var f=t.newNodeLink(s.getNodeProperties());f.setNetworkType(u.get(a).getNetworkType()),f.setEstimatedRate(u.get(a).getEstimatedRate());var l=u.get(a).getNetworkProperties();l.size()>0&&f.removeAllNetworkProperties();for(var c=0;c<l.size();c++){var h=t.newNetworkProperty(f);h.setKey(l.get(c).getName()),h.setValue(l.get(c).getValue()),f.addNetworkProperty(h)}s.getNodeProperties().addLink(f)}}}}function c(e,t){var n=t.getMetaData(),r=100,i=100;if(n!=null){var s=n.split(",");for(var o=0;o<s.length;o++)s[o].substr(0,"x=".length)=="x="&&(r=parseInt(s[o].substr("x=".length,s[o].length-1))),s[o].substr(0,"y=".length)=="y="&&(i=parseInt(s[o].substr("y=".length,s[o].length-1)))}e.getUI().getShape().setAbsolutePosition(r,i)}function h(t,n,r){function i(e,t){var n=e.getValues()?e.getValues().iterator():null;if(n)while(n.hasNext()){var i=n.next(),s=r.newValue();s.setName(i.getName()),s.setValue(i.getValue()),t.addValue(s)}}console.log("loadDictionaryValues",t,n);var s=n.getDictionary(),o=r.newDictionary(t,!1);s!=null&&s!=undefined&&i(s,o);var u=n.getFragmentDictionary()?n.getFragmentDictionary().iterator():null;if(u)while(u.hasNext()){var a=u.next(),f=r.newFragmentDictionary(t);f.setName(a.getName()),i(a,f),t.addFragmentDictionary(f)}var l=n.getTypeDefinition().getDictionaryType(),c=l.getAttributes()?l.getAttributes().iterator():null;if(c)while(c.hasNext()){var h=c.next(),p=r.newAttribute();p.setName(h.getName()),p.setOptional(e.parseBoolean(h.getOptional())),p.setFragmentDependant(e.parseBoolean(h.getFragmentDependant())),p.setDefaultValue(h.getDefaultValue()),t.addDictionaryAttribute(p)}}return r.prototype.visitEditor=function(e){var t=e.getModel();i(e,this._factory,t.getNodes()),s(e,this._factory,t.getGroups()),u(e,this._factory,t.getHubs()),o(e,this._factory,t.getNodes()),f(e,this._factory,t.getMBindings()),a(e,this._factory,t.getGroups()),l(e,this._factory,t.getNodeNetworks())},r});