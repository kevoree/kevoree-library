#!/bin/bash
#
# jedartois@gmail.com
# erwan.daubert@gmail.com
#
# script install and configure lxc for ubuntu
# Tested with Ubuntu Server 13.10 kernel 3.11.0-15-generic

echo "Install LXC"
sudo apt-get install lxc  --force-yes -y

echo "Install bridge-utils debootstrap"
sudo apt-get install  bridge-utils debootstrap --force-yes -y

echo "Checking lxc-checkconfig"
#check lxc config
checklxc=`lxc-checkconfig | grep disabled`
if [ "$checklxc" == "1" ]
        then
            echo "Your kernel configure is not supporting LXC"
        exit -1
    fi

echo "Configure network"
#configure bridge
cat >> "/etc/network/interfaces" << EOF

auto lxcbr0
iface lxcbr0 inet dhcp
    bridge_ports eth0
    bridge_stp off
    bridge_fd 0
    bridge_maxwait 0
EOF

echo "Configure LXC"

cat > "/etc/default/lxc-net" << EOF
# This file is auto-generated by lxc.postinst if it does not
# exist.  Customizations will not be overridden.
# Leave USE_LXC_BRIDGE as "true" if you want to use lxcbr0 for your
# containers.  Set to "false" if you'll use virbr0 or another existing
# bridge, or mavlan to your host's NIC.
USE_LXC_BRIDGE="true"

# If you change the LXC_BRIDGE to something other than lxcbr0, then
# you will also need to update your /etc/lxc/default.conf as well as the
# configuration (/var/lib/lxc/<container>/config) for any containers
# already created using the default config to reflect the new bridge
# name.
# If you have the dnsmasq daemon installed, you'll also have to update
# /etc/dnsmasq.d/lxc and restart the system wide dnsmasq daemon.
LXC_BRIDGE="lxcbr0"
#LXC_ADDR="10.0.3.1"
#LXC_NETMASK="255.255.255.0"
#LXC_NETWORK="10.0.3.0/24"
#LXC_DHCP_RANGE="10.0.3.2,10.0.3.254"
#LXC_DHCP_MAX="253"

# Uncomment the next line if you'd like to use a conf-file for the lxcbr0
# dnsmasq.  For instance, you can use 'dhcp-host=mail1,10.0.3.100' to have
# container 'mail1' always get ip address 10.0.3.100.
#LXC_DHCP_CONFILE=/etc/lxc/dnsmasq.conf

# Uncomment the next line if you want lxcbr0's dnsmasq to resolve the .lxc
# domain.  You can then add "server=/lxc/10.0.3.1' (or your actual )
# to /etc/dnsmasq.conf, after which 'container1.lxc' will resolve on your
# host.
#LXC_DOMAIN="lxc"

EOF

echo "configure NAT"
echo 1 > /proc/sys/net/ipv4/ip_forward

# reboot
echo "Press enter when you are ready to reboot:"
read
sudo reboot
